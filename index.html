<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí¨ –õ–æ–∫–∞–ª—å–Ω–∏–π –ß–∞—Ç Pro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
        body { background: linear-gradient(135deg, #6a11cb, #2575fc); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 900px; height: 700px; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .auth-screen, .chat-screen { height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; }
        .chat-screen { display: none; }
        .auth-form { width: 100%; max-width: 300px; }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; }
        .auth-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #6a11cb, #2575fc); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .error { color: #ff3b30; text-align: center; margin-top: 10px; min-height: 20px; }
        .header { background: linear-gradient(135deg, #6a11cb, #2575fc); color: white; padding: 15px 20px; width: 100%; display: flex; justify-content: space-between; align-items: center; }
        .main { display: flex; flex: 1; width: 100%; }
        .sidebar { width: 250px; background: #f8f9ff; padding: 20px; border-right: 1px solid #eaeaea; }
        .chat-area { flex: 1; display: flex; flex-direction: column; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; background: #fafbff; }
        .message { max-width: 70%; margin: 8px 0; padding: 10px 15px; border-radius: 15px; word-wrap: break-word; }
        .my-message { background: linear-gradient(135deg, #6a11cb, #2575fc); color: white; margin-left: auto; }
        .other-message { background: white; color: #333; border: 2px solid #f0f0f0; margin-right: auto; }
        .private-message { background: linear-gradient(135deg, #ff6b6b, #ffa726); color: white; margin-left: auto; }
        .received-private { background: linear-gradient(135deg, #4ecdc4, #44a08d); color: white; margin-right: auto; }
        .input-area { padding: 15px; border-top: 1px solid #eaeaea; display: flex; gap: 10px; background: white; }
        #messageInput { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 20px; font-size: 14px; outline: none; }
        #sendBtn { background: #6a11cb; color: white; border: none; padding: 0 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        
        /* –ù–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –Ω–æ–≤–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π */
        .action-buttons { display: flex; gap: 5px; margin-bottom: 15px; }
        .action-btn { padding: 8px 12px; background: #2575fc; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; flex: 1; }
        .action-btn:hover { opacity: 0.9; }
        .pm-btn { background: #9c27b0; }
        .dice-btn { background: #ff9800; }
        .search-btn { background: #4caf50; }
        
        .emoji-panel { 
            position: absolute; 
            bottom: 70px; 
            right: 20px; 
            background: white; 
            border: 1px solid #ddd; 
            border-radius: 10px; 
            padding: 10px; 
            display: grid; 
            grid-template-columns: repeat(6, 1fr); 
            gap: 5px; 
            max-height: 150px; 
            overflow-y: auto; 
            display: none; 
            z-index: 100; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
        }
        .emoji-btn { font-size: 20px; background: none; border: none; cursor: pointer; padding: 5px; border-radius: 5px; }
        .emoji-btn:hover { background: #f0f0f0; }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .user-item, .chat-item { 
            padding: 10px; 
            background: white; 
            margin-bottom: 8px; 
            border-radius: 8px; 
            border: 1px solid #ddd; 
            cursor: pointer; 
            transition: all 0.2s;
        }
        .user-item:hover, .chat-item:hover { background: #f0f2ff; border-color: #6a11cb; }
        .chat-item.active { border-color: #6a11cb; background: #f0f2ff; }
        
        .tab-buttons { display: flex; margin-bottom: 15px; background: #f0f0f0; border-radius: 8px; padding: 4px; }
        .tab-btn { flex: 1; padding: 8px; text-align: center; cursor: pointer; border-radius: 6px; font-size: 13px; }
        .tab-btn.active { background: #6a11cb; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ï–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó -->
        <div class="auth-screen" id="authScreen">
            <h1 style="color: #333; margin-bottom: 20px;">üí¨ –õ–æ–∫–∞–ª—å–Ω–∏–π –ß–∞—Ç Pro</h1>
            <div class="auth-form">
                <input type="text" id="username" class="auth-input" placeholder="–í–∞—à–µ —ñ–º'—è" autocomplete="off">
                <button class="auth-btn" onclick="login()">–£–≤—ñ–π—Ç–∏ –≤ —á–∞—Ç</button>
                <div class="error" id="errorMessage"></div>
                <div style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
                    –í–≤–µ–¥—ñ—Ç—å –±—É–¥—å-—è–∫–µ —ñ–º'—è<br>
                    –ß–∞—Ç –ø—Ä–∞—Ü—é—î –≤ —Ü—å–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ
                </div>
            </div>
        </div>
        
        <!-- –ï–∫—Ä–∞–Ω —á–∞—Ç—É -->
        <div class="chat-screen" id="chatScreen">
            <div class="header">
                <h2>
                    üí¨ –ß–∞—Ç: <span id="chatName">–ó–∞–≥–∞–ª—å–Ω–∏–π</span>
                    <span id="pmIndicator" style="font-size: 12px; color: #ff6b6b; display: none;"> [–ü—Ä–∏–≤–∞—Ç–Ω–æ]</span>
                </h2>
                <div>
                    <span id="currentUser">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</span>
                    <button onclick="logout()" style="background: #ff3b30; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-left: 15px;">–í–∏–π—Ç–∏</button>
                </div>
            </div>
            
            <div class="main">
                <div class="sidebar">
                    <!-- –ö–Ω–æ–ø–∫–∏ –¥—ñ–π -->
                    <div class="action-buttons">
                        <button class="action-btn" onclick="createChat()">‚ûï –ß–∞—Ç</button>
                        <button class="action-btn pm-btn" onclick="showPrivateTab()">üí¨ –ü—Ä–∏–≤–∞—Ç–Ω—ñ</button>
                        <button class="action-btn dice-btn" onclick="rollDice()">üé≤ –ö—ñ—Å—Ç–∫–∏</button>
                        <button class="action-btn search-btn" onclick="searchMessages()">üîç –ü–æ—à—É–∫</button>
                    </div>
                    
                    <!-- –¢–∞–±–∏ -->
                    <div class="tab-buttons">
                        <div class="tab-btn active" onclick="showTab('chats')">–ß–∞—Ç–∏</div>
                        <div class="tab-btn" onclick="showTab('users')">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</div>
                        <div class="tab-btn" onclick="showTab('private')">–ü—Ä–∏–≤–∞—Ç–Ω—ñ</div>
                    </div>
                    
                    <!-- –í–º—ñ—Å—Ç —Ç–∞–±—ñ–≤ -->
                    <div id="chatsTab" style="display: block; max-height: 400px; overflow-y: auto;">
                        <div id="chatsList"></div>
                    </div>
                    
                    <div id="usersTab" style="display: none; max-height: 400px; overflow-y: auto;">
                        <div id="onlineUsers"></div>
                    </div>
                    
                    <div id="privateTab" style="display: none; max-height: 400px; overflow-y: auto;">
                        <div id="privateChatsList"></div>
                        <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                            <select id="pmUserSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px;">
                                <option value="">–û–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</option>
                            </select>
                            <button onclick="startPrivateChat()" style="width: 100%; padding: 8px; background: #9c27b0; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                –ü–æ—á–∞—Ç–∏ –±–µ—Å—ñ–¥—É
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="chat-area">
                    <div class="messages" id="messages">
                        <div style="text-align: center; color: #666; padding: 50px 20px;">
                            <div style="font-size: 60px; margin-bottom: 20px; opacity: 0.5;">üëã</div>
                            <h3 style="margin-bottom: 10px;">–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –≤ —á–∞—Ç!</h3>
                            <p>–°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π —á–∞—Ç –∞–±–æ –æ–±–µ—Ä—ñ—Ç—å —ñ—Å–Ω—É—é—á–∏–π</p>
                        </div>
                    </div>
                    
                    <div class="input-area">
                        <button onclick="toggleEmojiPanel()" style="background: none; border: none; font-size: 20px; cursor: pointer; padding: 0 10px;">üòä</button>
                        <button onclick="sendImage()" style="background: none; border: none; font-size: 20px; cursor: pointer; padding: 0 10px;">üñºÔ∏è</button>
                        <button onclick="scheduleMessage()" style="background: none; border: none; font-size: 20px; cursor: pointer; padding: 0 10px;">‚è∞</button>
                        
                        <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." disabled>
                        <button id="sendBtn" onclick="sendMessage()" disabled>–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
                    </div>
                    
                    <!-- –ï–º–æ–¥–∑—ñ –ø–∞–Ω–µ–ª—å -->
                    <div class="emoji-panel" id="emojiPanel"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è -->
    <div class="notification" id="notification"></div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è -->
    <div id="inviteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px;">
            <h3 style="margin-bottom: 15px;">üì© –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è –¥–æ —á–∞—Ç—É</h3>
            <p id="inviteMessage" style="margin-bottom: 20px;"></p>
            <div style="display: flex; gap: 10px;">
                <button onclick="acceptInvite()" style="flex: 1; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">–ü—Ä–∏–π–Ω—è—Ç–∏</button>
                <button onclick="declineInvite()" style="flex: 1; padding: 10px; background: #ff3b30; color: white; border: none; border-radius: 5px; cursor: pointer;">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
            </div>
        </div>
    </div>

    <script>
        // ========== –û–°–ù–û–í–ù–Ü –ó–ú–Ü–ù–ù–Ü ==========
        let currentUser = null;
        let currentChat = 'general';
        let isPrivateChat = false;
        let privateChatWith = null;
        
        // –°–¢–†–£–ö–¢–£–†–ò –î–ê–ù–ò–•
        let chats = {};
        let messages = {};
        let users = {};
        let privateMessages = {};
        let invitations = {};
        
        // –ï–ú–û–î–ó–Ü
        const EMOJIS = ['üòÄ','üòÇ','ü•∞','üòé','ü§î','üéâ','‚ù§Ô∏è','üî•','üëç','üëè','üéØ','üíØ','ü§£','üòä','ü•∫','üòç','üôè','üòÖ','üò≠','ü§¶','üëÄ','üíÄ','‚ú®','üí™','üò±'];
        
        // ========== –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ==========
        function init() {
            loadData();
            initEmojiPanel();
            document.getElementById('username').focus();
            
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–ø—Ä–æ—à–µ–Ω—å –∫–æ–∂–Ω—ñ 5 —Å–µ–∫—É–Ω–¥
            setInterval(checkInvitations, 5000);
            // –ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
            setInterval(updateInterface, 2000);
        }
        
        function loadData() {
            chats = JSON.parse(localStorage.getItem('chats') || '{}');
            messages = JSON.parse(localStorage.getItem('messages') || '{}');
            users = JSON.parse(localStorage.getItem('users') || '{}');
            privateMessages = JSON.parse(localStorage.getItem('privateMessages') || '{}');
            invitations = JSON.parse(localStorage.getItem('invitations') || '{}');
            
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ —á–∞—Ç—É
            if (!chats.general) {
                chats.general = {
                    name: '–ó–∞–≥–∞–ª—å–Ω–∏–π —á–∞—Ç',
                    createdBy: 'system',
                    members: [],
                    isPublic: true,
                    type: 'group'
                };
                messages.general = [];
            }
        }
        
        function saveData() {
            localStorage.setItem('chats', JSON.stringify(chats));
            localStorage.setItem('messages', JSON.stringify(messages));
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('privateMessages', JSON.stringify(privateMessages));
            localStorage.setItem('invitations', JSON.stringify(invitations));
        }
        
        function initEmojiPanel() {
            const panel = document.getElementById('emojiPanel');
            EMOJIS.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-btn';
                btn.textContent = emoji;
                btn.onclick = () => insertEmoji(emoji);
                panel.appendChild(btn);
            });
        }
        
        // ========== –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Ø ==========
        function login() {
            const username = document.getElementById('username').value.trim();
            
            if (!username) {
                showError('–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º\'—è');
                return;
            }
            
            if (username.length < 2) {
                showError('–Ü–º\'—è –º–∞—î –±—É—Ç–∏ –º—ñ–Ω—ñ–º—É–º 2 —Å–∏–º–≤–æ–ª–∏');
                return;
            }
            
            currentUser = username;
            
            // –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            if (!users[username]) {
                users[username] = {
                    name: username,
                    joined: Date.now(),
                    lastSeen: Date.now()
                };
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ–¥–∞—î–º–æ –≤ –∑–∞–≥–∞–ª—å–Ω–∏–π —á–∞—Ç
                if (!chats.general.members.includes(username)) {
                    chats.general.members.push(username);
                }
            } else {
                users[username].lastSeen = Date.now();
            }
            
            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
            document.getElementById('currentUser').textContent = currentUser;
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'flex';
            
            saveData();
            selectChat('general');
            updateInterface();
            showNotification(`–í—ñ—Ç–∞—î–º–æ, ${username}! üëã`);
        }
        
        function logout() {
            if (confirm('–í–∏–π—Ç–∏ –∑ —á–∞—Ç—É?')) {
                currentUser = null;
                document.getElementById('chatScreen').style.display = 'none';
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('username').value = '';
                document.getElementById('username').focus();
            }
        }
        
        // ========== –¢–ê–ë–ò ==========
        function showTab(tabName) {
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤—Å—ñ —Ç–∞–±–∏
            document.getElementById('chatsTab').style.display = 'none';
            document.getElementById('usersTab').style.display = 'none';
            document.getElementById('privateTab').style.display = 'none';
            
            // –í–∏–¥–∞–ª—è—î–º–æ –∞–∫—Ç–∏–≤–Ω–∏–π –∫–ª–∞—Å
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ—Ç—Ä—ñ–±–Ω—É –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabName + 'Tab').style.display = 'block';
            event.target.classList.add('active');
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –≤–º—ñ—Å—Ç
            if (tabName === 'users') loadUsersList();
            if (tabName === 'private') loadPrivateChatsList();
        }
        
        function showPrivateTab() {
            showTab('private');
        }
        
        // ========== –ß–ê–¢–ò ==========
        function selectChat(chatId) {
            if (chatId.startsWith('pm_')) {
                // –ü—Ä–∏–≤–∞—Ç–Ω–∏–π —á–∞—Ç
                const parts = chatId.split('_');
                privateChatWith = parts[1] === currentUser ? parts[2] : parts[1];
                isPrivateChat = true;
                currentChat = chatId;
                
                document.getElementById('chatName').textContent = privateChatWith;
                document.getElementById('pmIndicator').style.display = 'inline';
            } else {
                // –ì—Ä—É–ø–æ–≤–∏–π —á–∞—Ç
                isPrivateChat = false;
                privateChatWith = null;
                currentChat = chatId;
                
                document.getElementById('chatName').textContent = chats[chatId].name;
                document.getElementById('pmIndicator').style.display = 'none';
            }
            
            // –ê–∫—Ç–∏–≤–∞—Ü—ñ—è –ø–æ–ª—è –≤–≤–æ–¥—É
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('messageInput').focus();
            
            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
            updateChatsList();
            loadMessages();
        }
        
        function createChat() {
            const chatName = prompt('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –Ω–æ–≤–æ–≥–æ —á–∞—Ç—É:');
            if (!chatName) return;
            
            const chatId = 'chat_' + Date.now();
            chats[chatId] = {
                name: chatName,
                createdBy: currentUser,
                members: [currentUser],
                type: 'group',
                isPublic: false,
                createdAt: Date.now()
            };
            
            messages[chatId] = [];
            saveData();
            selectChat(chatId);
            showNotification(`–ß–∞—Ç "${chatName}" —Å—Ç–≤–æ—Ä–µ–Ω–æ!`);
        }
        
        function updateChatsList() {
            const container = document.getElementById('chatsList');
            container.innerHTML = '';
            
            Object.keys(chats).forEach(chatId => {
                const chat = chats[chatId];
                if (chat.type !== 'group') return;
                if (!chat.isPublic && !chat.members.includes(currentUser)) return;
                
                const chatElement = document.createElement('div');
                chatElement.className = `chat-item ${currentChat === chatId && !isPrivateChat ? 'active' : ''}`;
                chatElement.onclick = () => selectChat(chatId);
                
                const lastMessage = messages[chatId] && messages[chatId].length > 0 
                    ? messages[chatId][messages[chatId].length - 1] 
                    : null;
                
                chatElement.innerHTML = `
                    <div style="font-weight: bold;">${chat.name}</div>
                    <div style="font-size: 12px; color: #666;">
                        ${chat.members.length} —É—á–∞—Å–Ω–∏–∫—ñ–≤
                        ${lastMessage ? `<br>${lastMessage.sender === currentUser ? '–í–∏' : lastMessage.sender}: ${lastMessage.text.substring(0, 20)}${lastMessage.text.length > 20 ? '...' : ''}` : ''}
                    </div>
                `;
                
                container.appendChild(chatElement);
            });
        }
        
        // ========== –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø ==========
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            if (isPrivateChat) {
                sendPrivateMessage(text);
            } else {
                sendGroupMessage(text);
            }
            
            input.value = '';
            input.focus();
        }
        
        function sendGroupMessage(text) {
            if (!messages[currentChat]) messages[currentChat] = [];
            
            messages[currentChat].push({
                sender: currentUser,
                text: text,
                timestamp: Date.now()
            });
            
            saveData();
            loadMessages();
        }
        
        function sendPrivateMessage(text) {
            const chatKey = getPrivateChatKey(currentUser, privateChatWith);
            
            if (!privateMessages[chatKey]) {
                privateMessages[chatKey] = [];
            }
            
            privateMessages[chatKey].push({
                sender: currentUser,
                receiver: privateChatWith,
                text: text,
                timestamp: Date.now(),
                read: false
            });
            
            saveData();
            loadMessages();
            loadPrivateChatsList();
        }
        
        function loadMessages() {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            
            let messagesList = [];
            
            if (isPrivateChat) {
                const chatKey = getPrivateChatKey(currentUser, privateChatWith);
                messagesList = privateMessages[chatKey] || [];
                
                // –ü–æ–∑–Ω–∞—á–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —è–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω—ñ
                messagesList.forEach(msg => {
                    if (msg.receiver === currentUser) {
                        msg.read = true;
                    }
                });
            } else {
                messagesList = messages[currentChat] || [];
            }
            
            if (messagesList.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px 20px;">
                        <div style="font-size: 50px; margin-bottom: 20px; opacity: 0.5;">üí¨</div>
                        <h3 style="margin-bottom: 10px;">–©–µ –Ω–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</h3>
                        <p>–ù–∞–ø–∏—à—ñ—Ç—å –ø–µ—Ä—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è!</p>
                    </div>
                `;
                return;
            }
            
            messagesList.forEach(msg => {
                const isMyMessage = msg.sender === currentUser;
                const messageDiv = document.createElement('div');
                
                if (isPrivateChat) {
                    messageDiv.className = `message ${isMyMessage ? 'private-message' : 'received-private'}`;
                } else {
                    messageDiv.className = `message ${isMyMessage ? 'my-message' : 'other-message'}`;
                }
                
                messageDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">${isMyMessage ? '–í–∏' : msg.sender}</div>
                    <div>${msg.text}</div>
                    <div style="font-size: 11px; margin-top: 5px; text-align: right;">${new Date(msg.timestamp).toLocaleTimeString('uk-UA', {hour: '2-digit', minute: '2-digit'})}</div>
                `;
                
                container.appendChild(messageDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }
        
        // ========== –ü–†–ò–í–ê–¢–ù–Ü –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø ==========
        function loadPrivateChatsList() {
            const container = document.getElementById('privateChatsList');
            const select = document.getElementById('pmUserSelect');
            
            container.innerHTML = '';
            select.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</option>';
            
            // –û—Ç—Ä–∏–º—É—î–º–æ –≤—Å—ñ –ø—Ä–∏–≤–∞—Ç–Ω—ñ —á–∞—Ç–∏
            let privateChats = [];
            
            Object.keys(privateMessages).forEach(key => {
                const [user1, user2] = key.split('_');
                
                if (user1 === currentUser || user2 === currentUser) {
                    const otherUser = user1 === currentUser ? user2 : user1;
                    const messages = privateMessages[key];
                    const lastMessage = messages[messages.length - 1];
                    const unreadCount = messages.filter(m => m.receiver === currentUser && !m.read).length;
                    
                    privateChats.push({
                        otherUser: otherUser,
                        lastMessage: lastMessage,
                        unreadCount: unreadCount
                    });
                }
            });
            
            // –°–æ—Ä—Ç—É—î–º–æ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º
            privateChats.sort((a, b) => {
                return (b.lastMessage?.timestamp || 0) - (a.lastMessage?.timestamp || 0);
            });
            
            // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ
            privateChats.forEach(chat => {
                const chatElement = document.createElement('div');
                chatElement.className = `chat-item ${isPrivateChat && privateChatWith === chat.otherUser ? 'active' : ''}`;
                chatElement.onclick = () => selectPrivateChat(chat.otherUser);
                
                const lastMsg = chat.lastMessage ? 
                    (chat.lastMessage.sender === currentUser ? '–í–∏: ' : '') + 
                    chat.lastMessage.text.substring(0, 30) + 
                    (chat.lastMessage.text.length > 30 ? '...' : '') : 
                    '–ù–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å';
                
                chatElement.innerHTML = `
                    <div style="font-weight: bold;">${chat.otherUser}</div>
                    <div style="font-size: 12px; color: #666;">${lastMsg}</div>
                    ${chat.unreadCount > 0 ? `<div style="background: #ff3b30; color: white; border-radius: 50%; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; float: right;">${chat.unreadCount}</div>` : ''}
                `;
                
                container.appendChild(chatElement);
            });
            
            // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Å–ø–∏—Å–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
            Object.keys(users).forEach(username => {
                if (username !== currentUser) {
                    const option = document.createElement('option');
                    option.value = username;
                    option.textContent = username;
                    select.appendChild(option);
                }
            });
        }
        
        function selectPrivateChat(otherUser) {
            privateChatWith = otherUser;
            isPrivateChat = true;
            currentChat = `pm_${currentUser}_${otherUser}`;
            
            document.getElementById('chatName').textContent = otherUser;
            document.getElementById('pmIndicator').style.display = 'inline';
            
            // –ê–∫—Ç–∏–≤–∞—Ü—ñ—è –ø–æ–ª—è –≤–≤–æ–¥—É
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('messageInput').placeholder = `–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è ${otherUser}...`;
            document.getElementById('messageInput').focus();
            
            loadMessages();
            showNotification(`–ü—Ä–∏–≤–∞—Ç–Ω–∞ –±–µ—Å—ñ–¥–∞ –∑ ${otherUser}`);
        }
        
        function startPrivateChat() {
            const select = document.getElementById('pmUserSelect');
            const otherUser = select.value;
            
            if (!otherUser) {
                showNotification('–û–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞', 'error');
                return;
            }
            
            if (otherUser === currentUser) {
                showNotification('–í–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç–∏ —Å–∞–º–æ–º—É —Å–æ–±—ñ', 'error');
                return;
            }
            
            selectPrivateChat(otherUser);
        }
        
        function getPrivateChatKey(user1, user2) {
            return [user1, user2].sort().join('_');
        }
        
        // ========== –ö–û–†–ò–°–¢–£–í–ê–ß–Ü ==========
        function loadUsersList() {
            const container = document.getElementById('onlineUsers');
            container.innerHTML = '';
            
            Object.keys(users).forEach(username => {
                if (username === currentUser) return;
                
                const user = users[username];
                const isOnline = (Date.now() - user.lastSeen) < 300000; // 5 —Ö–≤–∏–ª–∏–Ω
                
                const userElement = document.createElement('div');
                userElement.className = 'user-item';
                
                userElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold;">${username}</div>
                            <div style="font-size: 12px; color: #666;">
                                ${isOnline ? 'üü¢ –û–Ω–ª–∞–π–Ω' : `‚ö´ –ë—É–≤ ${formatTimeAgo(user.lastSeen)}`}
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="event.stopPropagation(); selectPrivateChat('${username}')" style="background: #9c27b0; color: white; border: none; border-radius: 5px; padding: 5px 10px; font-size: 12px; cursor: pointer;">üí¨</button>
                            <button onclick="event.stopPropagation(); inviteToChat('${username}')" style="background: #2575fc; color: white; border: none; border-radius: 5px; padding: 5px 10px; font-size: 12px; cursor: pointer;">‚ûï</button>
                        </div>
                    </div>
                `;
                
                container.appendChild(userElement);
            });
        }
        
        function inviteToChat(username) {
            if (username === currentUser) {
                showNotification('–í–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∑–∞–ø—Ä–æ—Å–∏—Ç–∏ —Å–∞–º–æ–≥–æ —Å–µ–±–µ', 'error');
                return;
            }
            
            if (!chats[currentChat] || chats[currentChat].type !== 'group') {
                showNotification('–ú–æ–∂–Ω–∞ –∑–∞–ø—Ä–æ—à—É–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –≤ –≥—Ä—É–ø–æ–≤—ñ —á–∞—Ç–∏', 'error');
                return;
            }
            
            if (chats[currentChat].members.includes(username)) {
                showNotification('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ –≤ —á–∞—Ç—ñ', 'info');
                return;
            }
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è
            if (!invitations[username]) invitations[username] = [];
            invitations[username].push({
                chatId: currentChat,
                chatName: chats[currentChat].name,
                from: currentUser,
                timestamp: Date.now()
            });
            
            saveData();
            showNotification(`–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ ${username}`);
        }
        
        // ========== –ù–û–í–Ü –§–£–ù–ö–¶–Ü–á ==========
        
        // 1. –ï–º–æ–¥–∑—ñ
        function toggleEmojiPanel() {
            const panel = document.getElementById('emojiPanel');
            panel.style.display = panel.style.display === 'grid' ? 'none' : 'grid';
        }
        
        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            input.value += emoji;
            input.focus();
            toggleEmojiPanel();
        }
        
        // 2. –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        function sendImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('–§–∞–π–ª –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π (–º–∞–∫—Å. 5MB)', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const message = `[–ó–û–ë–†–ê–ñ–ï–ù–ù–Ø: ${file.name}] (${(file.size / 1024).toFixed(1)} KB)`;
                    
                    if (isPrivateChat) {
                        sendPrivateMessage(message);
                    } else {
                        sendGroupMessage(message);
                    }
                    
                    showNotification('–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ!');
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }
        
        // 3. –ö—ñ—Å—Ç–∫–∏
        function rollDice() {
            const dice1 = Math.floor(Math.random() * 6) + 1;
            const dice2 = Math.floor(Math.random() * 6) + 1;
            const total = dice1 + dice2;
            
            let message = `üé≤ ${currentUser} –∫–∏–Ω—É–≤ –∫—ñ—Å—Ç–∫–∏: ${dice1} + ${dice2} = ${total}`;
            
            if (total === 12) message += " üéØ –ö—Ä–∏—Ç–∏—á–Ω–∏–π —É–¥–∞—Ä!";
            else if (total >= 10) message += " üëç –í—ñ–¥–º—ñ–Ω–Ω–æ!";
            else if (total <= 4) message += " üòÖ –ù–µ –ø–æ—â–∞—Å—Ç–∏–ª–æ";
            
            if (isPrivateChat) {
                sendPrivateMessage(message);
            } else {
                sendGroupMessage(message);
            }
            
            showNotification('–ö—ñ—Å—Ç–∫–∏ –∫–∏–Ω—É—Ç—ñ! üé≤');
        }
        
        // 4. –í—ñ–¥–∫–ª–∞–¥–µ–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        function scheduleMessage() {
            const time = prompt('–ß–µ—Ä–µ–∑ —Å–∫—ñ–ª—å–∫–∏ —Ö–≤–∏–ª–∏–Ω –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏? (1-60)', '5');
            if (!time) return;
            
            const minutes = parseInt(time);
            if (isNaN(minutes) || minutes < 1 || minutes > 60) {
                showNotification('–í–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ –≤—ñ–¥ 1 –¥–æ 60', 'error');
                return;
            }
            
            const text = prompt('–¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:');
            if (!text) return;
            
            const scheduled = JSON.parse(localStorage.getItem('scheduledMessages') || '[]');
            scheduled.push({
                text: text,
                sendTime: Date.now() + (minutes * 60000),
                chat: currentChat,
                isPrivate: isPrivateChat,
                receiver: privateChatWith
            });
            
            localStorage.setItem('scheduledMessages', JSON.stringify(scheduled));
            showNotification(`–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –±—É–¥–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ ${minutes} —Ö–≤.`);
        }
        
        // 5. –ü–æ—à—É–∫
        function searchMessages() {
            const keyword = prompt('–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ—à—É–∫—É:');
            if (!keyword) return;
            
            let results = [];
            
            // –ü–æ—à—É–∫ –≤ –≥—Ä—É–ø–æ–≤–∏—Ö —á–∞—Ç–∞—Ö
            Object.entries(messages).forEach(([chatId, msgs]) => {
                msgs.forEach(msg => {
                    if (msg.text.toLowerCase().includes(keyword.toLowerCase())) {
                        results.push({
                            ...msg,
                            chatId,
                            chatName: chats[chatId]?.name || '–ù–µ–≤—ñ–¥–æ–º–∏–π —á–∞—Ç'
                        });
                    }
                });
            });
            
            // –ü–æ—à—É–∫ –≤ –ø—Ä–∏–≤–∞—Ç–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è—Ö
            Object.entries(privateMessages).forEach(([key, msgs]) => {
                msgs.forEach(msg => {
                    if (msg.text.toLowerCase().includes(keyword.toLowerCase())) {
                        results.push({
                            ...msg,
                            chatId: key,
                            chatName: msg.sender === currentUser ? key.split('_')[1] : key.split('_')[0]
                        });
                    }
                });
            });
            
            if (results.length === 0) {
                showNotification('–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'info');
                return;
            }
            
            // –ü–æ–∫–∞–∑—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏
            let resultHTML = `<h3>üîç –ó–Ω–∞–π–¥–µ–Ω–æ ${results.length} —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤:</h3>`;
            results.forEach((msg, i) => {
                resultHTML += `
                    <div style="padding: 10px; border-bottom: 1px solid #ddd; margin-bottom: 10px;">
                        <div><strong>${msg.chatName}</strong> - ${msg.sender}:</div>
                        <div>${msg.text}</div>
                        <div style="font-size: 12px; color: #666;">${new Date(msg.timestamp).toLocaleString()}</div>
                    </div>
                `;
            });
            
            alert(resultHTML);
        }
        
        // 6. –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è
        function checkInvitations() {
            if (!currentUser || !invitations[currentUser] || invitations[currentUser].length === 0) return;
            
            const invite = invitations[currentUser][invitations[currentUser].length - 1];
            
            document.getElementById('inviteMessage').textContent = 
                `${invite.from} –∑–∞–ø—Ä–æ—à—É—î –≤–∞—Å –¥–æ —á–∞—Ç—É "${invite.chatName}"`;
            
            document.getElementById('inviteModal').style.display = 'flex';
        }
        
        function acceptInvite() {
            const invite = invitations[currentUser].pop();
            
            if (!chats[invite.chatId].members.includes(currentUser)) {
                chats[invite.chatId].members.push(currentUser);
            }
            
            if (invitations[currentUser].length === 0) {
                delete invitations[currentUser];
            }
            
            saveData();
            document.getElementById('inviteModal').style.display = 'none';
            selectChat(invite.chatId);
            showNotification(`–í–∏ –ø—Ä–∏—î–¥–Ω–∞–ª–∏—Å—è –¥–æ —á–∞—Ç—É "${invite.chatName}"!`);
        }
        
        function declineInvite() {
            invitations[currentUser].pop();
            if (invitations[currentUser].length === 0) {
                delete invitations[currentUser];
            }
            
            saveData();
            document.getElementById('inviteModal').style.display = 'none';
            showNotification('–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ');
        }
        
        // ========== –£–¢–ò–õ–Ü–¢–ò ==========
        function updateInterface() {
            if (!currentUser) return;
            
            updateChatsList();
            loadUsersList();
            loadPrivateChatsList();
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤—ñ–¥–∫–ª–∞–¥–µ–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            checkScheduledMessages();
        }
        
        function checkScheduledMessages() {
            const scheduled = JSON.parse(localStorage.getItem('scheduledMessages') || '[]');
            const now = Date.now();
            const toSend = scheduled.filter(msg => msg.sendTime <= now);
            
            toSend.forEach(msg => {
                if (msg.isPrivate) {
                    const chatKey = getPrivateChatKey(currentUser, msg.receiver);
                    if (!privateMessages[chatKey]) privateMessages[chatKey] = [];
                    
                    privateMessages[chatKey].push({
                        sender: currentUser,
                        receiver: msg.receiver,
                        text: msg.text,
                        timestamp: now,
                        read: false
                    });
                } else {
                    if (!messages[msg.chat]) messages[msg.chat] = [];
                    
                    messages[msg.chat].push({
                        sender: currentUser,
                        text: msg.text,
                        timestamp: now
                    });
                }
            });
            
            // –í–∏–¥–∞–ª—è—î–º–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—ñ
            const remaining = scheduled.filter(msg => msg.sendTime > now);
            localStorage.setItem('scheduledMessages', JSON.stringify(remaining));
            
            if (toSend.length > 0) {
                saveData();
                if (currentChat === toSend[0].chat) {
                    loadMessages();
                }
            }
        }
        
        function formatTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            
            if (seconds < 60) return '—â–æ–π–Ω–æ';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} —Ö–≤ —Ç–æ–º—É`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} –≥–æ–¥ —Ç–æ–º—É`;
            return `${Math.floor(seconds / 86400)} –¥–Ω —Ç–æ–º—É`;
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            
            // –ö–æ–ª—ñ—Ä –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ —Ç–∏–ø—É
            notification.style.background = 
                type === 'error' ? '#ff3b30' : 
                type === 'warning' ? '#ffa726' : '#4CAF50';
            
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            setTimeout(() => errorDiv.textContent = '', 3000);
        }
        
        // ========== –ó–ê–ü–£–°–ö ==========
        init();
        
        // –û–±—Ä–æ–±–∫–∞ Enter
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–∏—Ö –≤—ñ–∫–æ–Ω
        window.onclick = function(event) {
            const modal = document.getElementById('inviteModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
