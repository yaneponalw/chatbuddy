<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí¨ –ß–∞—Ç –∑ –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è–º–∏</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            height: 750px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .auth-screen {
            padding: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        
        .auth-form {
            width: 100%;
            max-width: 350px;
        }
        
        .auth-input {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 15px;
        }
        
        .auth-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .error {
            color: #ff3b30;
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            min-height: 20px;
        }
        
        .chat-screen {
            display: none;
            flex-direction: column;
            height: 100%;
        }
        
        .header {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .main {
            display: flex;
            flex: 1;
            height: calc(100% - 60px);
        }
        
        .sidebar {
            width: 300px;
            background: #f8f9ff;
            border-right: 1px solid #eaeaea;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .section-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chats-list, .invitations-list {
            flex: 1;
            overflow-y: auto;
            max-height: 200px;
        }
        
        .chat-item, .invitation-item {
            padding: 12px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .chat-item:hover, .invitation-item:hover {
            border-color: #6a11cb;
            transform: translateX(3px);
        }
        
        .chat-item.active {
            background: #f0f2ff;
            border-color: #6a11cb;
        }
        
        .invitation-item {
            cursor: default;
        }
        
        .invitation-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        
        .invitation-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        
        .accept-btn {
            background: #4CAF50;
            color: white;
        }
        
        .decline-btn {
            background: #ff3b30;
            color: white;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #eaeaea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-info {
            flex: 1;
            cursor: pointer;
        }
        
        .chat-info:hover {
            opacity: 0.8;
        }
        
        .chat-title {
            font-weight: bold;
            font-size: 18px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chat-members {
            font-size: 13px;
            color: #666;
            margin-top: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .members-icon {
            font-size: 14px;
        }
        
        .chat-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 8px 15px;
            background: #6a11cb;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .invite-btn {
            background: #FF9800;
        }
        
        .file-btn {
            background: #4CAF50;
        }
        
        .voice-btn {
            background: #9C27B0;
        }
        
        .members-btn {
            background: #2196F3;
        }
        
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #fafbff;
        }
        
        .message {
            max-width: 70%;
            margin: 8px 0;
            padding: 12px 15px;
            border-radius: 15px;
            word-wrap: break-word;
            animation: fadeIn 0.3s;
        }
        
        .my-message {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            margin-left: auto;
        }
        
        .other-message {
            background: white;
            color: #333;
            border: 2px solid #f0f0f0;
            margin-right: auto;
        }
        
        .system-message {
            background: #f8f9ff;
            color: #666;
            border: 1px solid #e0e0f0;
            font-style: italic;
            text-align: center;
            margin: 5px auto;
            font-size: 13px;
            max-width: 80%;
        }
        
        .message-sender {
            font-weight: bold;
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .message-sender:hover {
            text-decoration: underline;
        }
        
        .file-message {
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            margin-top: 10px;
        }
        
        .file-preview {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .file-icon {
            font-size: 24px;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: bold;
            font-size: 14px;
        }
        
        .file-size {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .download-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .voice-message {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 10px;
        }
        
        .voice-player {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .play-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .voice-duration {
            font-size: 12px;
            opacity: 0.8;
            min-width: 40px;
        }
        
        .input-area {
            padding: 15px 20px;
            border-top: 1px solid #eaeaea;
            display: flex;
            gap: 10px;
            background: white;
            align-items: center;
        }
        
        .input-controls {
            display: flex;
            gap: 5px;
        }
        
        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #ddd;
            background: #f8f9ff;
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        #messageInput {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            min-height: 40px;
            max-height: 100px;
            resize: none;
        }
        
        #sendBtn {
            background: #6a11cb;
            color: white;
            border: none;
            padding: 0 25px;
            height: 40px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .recording-indicator {
            position: fixed;
            top: 100px;
            right: 20px;
            background: #ff3b30;
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            z-index: 2000;
            animation: pulse 1.5s infinite;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            box-shadow: 0 10px 25px rgba(255, 59, 48, 0.3);
        }
        
        .recording-dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: blink 1s infinite;
        }
        
        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #fafbff;
        }
        
        .emoji-btn {
            width: 35px;
            height: 35px;
            border: none;
            background: white;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .emoji-btn:hover {
            background: #f0f2ff;
            transform: scale(1.1);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 18px;
            background: #4CAF50;
            color: white;
            border-radius: 10px;
            z-index: 2000;
            animation: slideIn 0.3s;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è —Å–ø–∏—Å–∫—É —É—á–∞—Å–Ω–∏–∫—ñ–≤ */
        .members-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9ff;
            border-radius: 10px;
        }
        
        .member-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #eaeaea;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .member-item:hover {
            background: #f0f2ff;
            transform: translateX(5px);
        }
        
        .member-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .member-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .member-details {
            flex: 1;
        }
        
        .member-name {
            font-weight: bold;
            font-size: 14px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .member-email {
            font-size: 12px;
            color: #666;
        }
        
        .member-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            background: #4CAF50;
            color: white;
            flex-shrink: 0;
        }
        
        .member-status.offline {
            background: #9E9E9E;
        }
        
        .member-actions {
            display: flex;
            gap: 5px;
        }
        
        .remove-btn {
            background: #ff3b30;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .remove-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .creator-badge {
            background: #FF9800;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .you-badge {
            background: #2196F3;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .no-members {
            text-align: center;
            color: #666;
            padding: 30px;
            font-style: italic;
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø—Ä–æ—Ñ—ñ–ª—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ */
        .profile-modal {
            max-width: 450px;
        }
        
        .profile-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            margin: 0 auto 15px;
        }
        
        .profile-name {
            font-size: 22px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .profile-email {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .profile-badges {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .profile-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }
        
        .profile-creator {
            background: #FF9800;
        }
        
        .profile-online {
            background: #4CAF50;
        }
        
        .profile-offline {
            background: #9E9E9E;
        }
        
        .profile-you {
            background: #2196F3;
        }
        
        .profile-details {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        .profile-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0f0;
        }
        
        .profile-row:last-child {
            border-bottom: none;
        }
        
        .profile-label {
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }
        
        .profile-value {
            color: #333;
            font-size: 14px;
        }
        
        .profile-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .profile-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .profile-btn.primary {
            background: #6a11cb;
            color: white;
        }
        
        .profile-btn.secondary {
            background: #f0f2ff;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .profile-btn.danger {
            background: #ff3b30;
            color: white;
        }
        
        .profile-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è —Å–≤–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é */
        .my-profile-section {
            padding: 15px;
            background: #f0f2ff;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #6a11cb;
        }
        
        .my-profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .my-profile-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .my-profile-avatar input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .my-profile-info {
            flex: 1;
        }
        
        .my-profile-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .my-profile-email {
            font-size: 13px;
            color: #666;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #6a11cb;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #2575fc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="auth-screen" id="authScreen">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="color: #333; margin-bottom: 10px;">üí¨ –ß–∞—Ç –∑ –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è–º–∏</h1>
                <div style="color: #666;">–ó–∞–ø—Ä–æ—à—É–π –¥—Ä—É–∑—ñ–≤ —Ç–∞ —Å–ø—ñ–ª–∫—É–π—Å—è!</div>
            </div>
            
            <div class="auth-form">
                <input type="email" id="email" class="auth-input" placeholder="Email">
                <input type="password" id="password" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
                
                <button class="auth-btn" onclick="login()">–£–≤—ñ–π—Ç–∏ / –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
                
                <div class="error" id="errorMessage"></div>
                
                <div style="text-align: center; margin-top: 30px; color: #666; font-size: 13px;">
                    üë• –ó–∞–ø—Ä–æ—à—É–π –¥—Ä—É–∑—ñ–≤ –¥–æ —á–∞—Ç—ñ–≤<br>
                    üíå –ü—Ä–∏–π–º–∞–π –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è<br>
                    üí¨ –°–ø—ñ–ª–∫—É–π—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Ç—ñ
                </div>
                
                <div style="margin-top: 20px; text-align: center; font-size: 12px; color: #888;">
                    –í–≤–µ–¥—ñ—Ç—å —Å–≤—ñ–π email —Ç–∞ –ø–∞—Ä–æ–ª—å:<br>
                     –Ø–∫—â–æ –∞–∫–∞—É–Ω—Ç–∞ –Ω–µ–º–∞—î ‚Äî –≤—ñ–Ω —Å—Ç–≤–æ—Ä–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
                </div>
            </div>
        </div>
        
        <div class="chat-screen" id="chatScreen">
            <div class="header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button onclick="showMyProfile()" style="background: #6a11cb; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;" title="–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å">
                        üë§
                    </button>
                    <h2>üí¨ –ß–∞—Ç –∑ –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è–º–∏</h2>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span id="userEmail">user@test.com</span>
                    <button onclick="logout()" style="background: #ff3b30; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 13px;">
                        –í–∏–π—Ç–∏
                    </button>
                </div>
            </div>
            
            <div class="main">
                <div class="sidebar">
                    <div class="sidebar-section">
                        <button onclick="createChat()" style="width: 100%; padding: 12px; background: #6a11cb; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; margin-bottom: 10px;">
                            üí¨ –°—Ç–≤–æ—Ä–∏—Ç–∏ —á–∞—Ç
                        </button>
                        <button onclick="showEmojiPickerModal()" style="width: 100%; padding: 12px; background: #FF9800; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">
                            üòä –ï–º–æ–¥–∑—ñ –ø—ñ–∫–µ—Ä
                        </button>
                    </div>
                    
                    <div class="sidebar-section">
                        <div class="section-title">
                            <span>–ú–æ—ó —á–∞—Ç–∏</span>
                            <span id="chatsCount">0</span>
                        </div>
                        <div class="chats-list" id="chatsList"></div>
                    </div>
                    
                    <div class="sidebar-section" style="flex: 1;">
                        <div class="section-title">
                            <span>–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è</span>
                            <span id="invitationsCount">0</span>
                        </div>
                        <div class="invitations-list" id="invitationsList"></div>
                    </div>
                </div>
                
                <div class="chat-area">
                    <div class="chat-header">
                        <div class="chat-info" onclick="showMembersModal()">
                            <div class="chat-title" id="chatTitle">–û–±–µ—Ä—ñ—Ç—å —á–∞—Ç <span style="font-size: 14px;">üëÅÔ∏è</span></div>
                            <div class="chat-members" id="chatMembers">
                                <span class="members-icon">üë•</span>
                                <span id="membersCount">0 —É—á–∞—Å–Ω–∏–∫—ñ–≤</span>
                            </div>
                        </div>
                        <div class="chat-actions" id="chatActions" style="display: none;">
                            <button class="action-btn invite-btn" onclick="showInviteModal()">
                                üë• –ó–∞–ø—Ä–æ—Å–∏—Ç–∏
                            </button>
                            <button class="action-btn file-btn" onclick="attachFile()">
                                üìé –§–∞–π–ª
                            </button>
                            <button class="action-btn voice-btn" id="voiceRecordBtn" onclick="toggleVoiceRecording()">
                                üé§ –ì–æ–ª–æ—Å
                            </button>
                            <button class="action-btn members-btn" onclick="showMembersModal()">
                                üë§ –£—á–∞—Å–Ω–∏–∫–∏
                            </button>
                        </div>
                    </div>
                    
                    <div class="messages" id="messages">
                        <div style="text-align: center; color: #666; padding: 50px 20px;">
                            <div style="font-size: 60px; margin-bottom: 20px; opacity: 0.5;">üëã</div>
                            <h3 style="margin-bottom: 10px;">–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ!</h3>
                            <p>–û–±–µ—Ä—ñ—Ç—å —á–∞—Ç –∞–±–æ —Å—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π</p>
                        </div>
                    </div>
                    
                    <div class="input-area">
                        <div class="input-controls">
                            <button class="icon-btn" onclick="showEmojiPicker()" title="–î–æ–¥–∞—Ç–∏ –µ–º–æ–¥–∑—ñ">üòä</button>
                            <button class="icon-btn" onclick="attachFile()" title="–ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ —Ñ–∞–π–ª">üìé</button>
                            <button class="icon-btn" onclick="toggleVoiceRecording()" id="voiceBtn" title="–ó–∞–ø–∏—Å–∞—Ç–∏ –≥–æ–ª–æ—Å–æ–≤–µ">üé§</button>
                        </div>
                        <textarea id="messageInput" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." disabled></textarea>
                        <button id="sendBtn" onclick="sendMessage()" disabled><span>–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</span><span>‚úàÔ∏è</span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è -->
    <div class="modal" id="inviteModal">
        <div class="modal-content">
            <div class="modal-title">üë• –ó–∞–ø—Ä–æ—Å–∏—Ç–∏ –¥–æ —á–∞—Ç—É</div>
            <div style="margin-bottom: 20px;">
                <input type="email" id="inviteEmail" placeholder="Email –¥—Ä—É–≥–∞" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="auth-btn" onclick="sendInvitation()" style="flex: 1;">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è</button>
                <button class="auth-btn" onclick="closeModal('inviteModal')" style="flex: 1; background: #ccc; color: #333;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ñ–∞–π–ª—É -->
    <div class="modal" id="fileModal">
        <div class="modal-content">
            <div class="modal-title">üìé –ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ —Ñ–∞–π–ª</div>
            <div style="margin-bottom: 20px;">
                <input type="file" id="fileInput" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                <div id="filePreview" style="margin-top: 15px; display: none;"></div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="auth-btn" onclick="uploadFile()" style="flex: 1;" id="uploadBtn">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ñ–∞–π–ª</button>
                <button class="auth-btn" onclick="closeModal('fileModal')" style="flex: 1; background: #ccc; color: #333;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –µ–º–æ–¥–∑—ñ -->
    <div class="modal" id="emojiModal">
        <div class="modal-content">
            <div class="modal-title">üòä –ï–º–æ–¥–∑—ñ –ø—ñ–∫–µ—Ä</div>
            <div class="emoji-picker" id="emojiPicker"></div>
            <button class="auth-btn" onclick="closeModal('emojiModal')">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —É—á–∞—Å–Ω–∏–∫—ñ–≤ -->
    <div class="modal" id="membersModal">
        <div class="modal-content">
            <div class="modal-title">üë• –£—á–∞—Å–Ω–∏–∫–∏ —á–∞—Ç—É</div>
            <div style="margin-bottom: 15px; text-align: center; color: #666; font-size: 14px;" id="membersTitle">
                –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...
            </div>
            <div class="members-list" id="membersList"></div>
            <div style="margin-top: 20px; display: flex; justify-content: center;">
                <button class="auth-btn" onclick="closeModal('membersModal')" style="background: #ccc; color: #333;">
                    –ó–∞–∫—Ä–∏—Ç–∏
                </button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—Ä–æ—Ñ—ñ–ª—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ -->
    <div class="modal" id="profileModal">
        <div class="modal-content profile-modal">
            <div id="profileContent">
                <!-- –ü—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –±—É–¥–µ —Ç—É—Ç -->
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="profile-btn secondary" onclick="closeModal('profileModal')" style="flex: 1;">
                    –ó–∞–∫—Ä–∏—Ç–∏
                </button>
            </div>
        </div>
    </div>
    
    <!-- –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å—É –≥–æ–ª–æ—Å—É -->
    <div class="recording-indicator" id="recordingIndicator" style="display: none;">
        <div class="recording-dot"></div>
        <span>–ó–∞–ø–∏—Å –≥–æ–ª–æ—Å—É... –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∑–Ω–æ–≤—É –¥–ª—è –∑—É–ø–∏–Ω–∫–∏</span>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyALbB3mUwRXJZW3F6-1Du5L3sZEauTGoJ8",
            authDomain: "realchat-b80d7.firebaseapp.com",
            databaseURL: "https://realchat-b80d7-default-rtdb.firebaseio.com",
            projectId: "realchat-b80d7",
            storageBucket: "realchat-b80d7.firebasestorage.app",
            messagingSenderId: "201539346020",
            appId: "1:201539346020:web:de939b088c9db66b0a8971"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        let currentUser = null;
        let currentChat = null;
        let allUsers = {};
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let currentPlayingAudio = null;

        const emojis = [
            'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞',
            'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü•∏', 'ü§©',
            'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£', 'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢',
            'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨', 'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó',
            'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ', 'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±',
            'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê', 'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†', 'üòà',
            'üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëå', 'ü§å', 'ü§è', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ',
            'üëÜ', 'üñï', 'üëá', '‚òùÔ∏è', 'üëç', 'üëé', '‚úä', 'üëä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù',
            'üôè', '‚úçÔ∏è', 'üíÖ', 'ü§≥', 'üí™', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ', 'üß†', 'ü´Ä', 'ü´Å', 'ü¶∑', 'ü¶¥',
            'üëÄ', 'üëÅÔ∏è', 'üëÖ', 'üëÑ', 'üíã', 'ü©∏', '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é'
        ];

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            setTimeout(() => errorDiv.textContent = '', 3000);
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = type === 'error' ? '#ff3b30' : type === 'warning' ? '#FF9800' : '#4CAF50';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'inviteModal') document.getElementById('inviteEmail').value = '';
            else if (modalId === 'fileModal') {
                document.getElementById('fileInput').value = '';
                document.getElementById('filePreview').style.display = 'none';
            }
        }

     async function login() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (!email) { 
        showError('–í–≤–µ–¥—ñ—Ç—å email'); 
        return; 
    }
    
    if (!password) { 
        showError('–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å'); 
        return; 
    }
    
    if (password.length < 6) { 
        showError('–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤'); 
        return; 
    }
    
    try {
        let userCredential;
        
        try {
            userCredential = await auth.signInWithEmailAndPassword(email, password);
            showNotification('–í—Ö—ñ–¥ —É—Å–ø—ñ—à–Ω–∏–π! üëã');
        } 
        catch (signInError) {
            if (signInError.code === 'auth/user-not-found' || signInError.code === 'auth/wrong-password') {
                userCredential = await auth.createUserWithEmailAndPassword(email, password);
                showNotification('–ù–æ–≤–∏–π –∞–∫–∞—É–Ω—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ! üéâ');
            } else {
                throw signInError;
            }
        }
        
        currentUser = userCredential.user;
        
        await db.ref('users/' + currentUser.uid).update({
            uid: currentUser.uid,
            email: email,
            name: email.split('@')[0],
            online: true,
            lastSeen: Date.now(),
            createdAt: firebase.database.ServerValue.TIMESTAMP
        });
        
        document.getElementById('userEmail').textContent = currentUser.email;
        startChat();
        
    } catch (error) {
        let errorMessage = '';
        
        switch(error.code) {
            case 'auth/email-already-in-use':
                errorMessage = '–¶–µ–π email –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π. –°–ø—Ä–æ–±—É–π—Ç–µ —É–≤—ñ–π—Ç–∏.';
                break;
            case 'auth/invalid-email':
                errorMessage = '–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç email';
                break;
            case 'auth/weak-password':
                errorMessage = '–ü–∞—Ä–æ–ª—å –∑–∞–Ω–∞–¥—Ç–æ —Å–ª–∞–±–∫–∏–π. –ú—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤.';
                break;
            case 'auth/wrong-password':
                errorMessage = '–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.';
                break;
            case 'auth/user-not-found':
                errorMessage = '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –∞–∫–∞—É–Ω—Ç.';
                break;
            default:
                errorMessage = '–ü–æ–º–∏–ª–∫–∞: ' + error.message;
        }
        
        showError(errorMessage);
    }
}
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'flex';
            loadAllUsers();
            loadMyChats();
            loadInvitations();
            createGlobalChat();
        }

        function loadAllUsers() {
            db.ref('users').on('value', (snapshot) => {
                allUsers = snapshot.val() || {};
                
                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –æ–Ω–ª–∞–π–Ω –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                if (currentUser) {
                    db.ref('users/' + currentUser.uid).update({
                        online: true,
                        lastSeen: Date.now()
                    });
                }
            });
        }

        function loadMyChats() {
            db.ref('chats').on('value', (snapshot) => {
                const chatsData = snapshot.val();
                const container = document.getElementById('chatsList');
                let myChats = [];
                container.innerHTML = '';
                
                if (!chatsData) {
                    container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">–©–µ –Ω–µ–º–∞—î —á–∞—Ç—ñ–≤</div>';
                    document.getElementById('chatsCount').textContent = '0';
                    return;
                }
                
                Object.keys(chatsData).forEach(chatId => {
                    const chat = chatsData[chatId];
                    chat.id = chatId;
                    
                    if (chat.participants && chat.participants[currentUser.uid]) {
                        myChats.push(chat);
                        const memberCount = chat.participants ? Object.keys(chat.participants).length : 0;
                        const chatElement = document.createElement('div');
                        chatElement.className = 'chat-item';
                        if (currentChat && currentChat.id === chatId) chatElement.classList.add('active');
                        chatElement.onclick = () => selectChat(chat);
                        chatElement.innerHTML = `
                            <div style="font-weight: bold; margin-bottom: 3px;">${chat.name || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</div>
                            <div style="font-size: 12px; color: #666;">
                                ${memberCount} —É—á–∞—Å–Ω–∏–∫—ñ–≤ ‚Ä¢ ${chat.lastMessage ? chat.lastMessage.text.substring(0, 20) + '...' : '–ù–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å'}
                            </div>
                        `;
                        container.appendChild(chatElement);
                    }
                });
                
                document.getElementById('chatsCount').textContent = myChats.length;
                if (myChats.length === 0) {
                    container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">–£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î —á–∞—Ç—ñ–≤</div>';
                }
            });
        }

        function loadInvitations() {
            db.ref('invitations').orderByChild('toUserId').equalTo(currentUser.uid).on('value', (snapshot) => {
                const invitationsData = snapshot.val();
                const container = document.getElementById('invitationsList');
                let invitations = [];
                container.innerHTML = '';
                
                if (!invitationsData) {
                    container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">–ù–µ–º–∞—î –∑–∞–ø—Ä–æ—à–µ–Ω—å</div>';
                    document.getElementById('invitationsCount').textContent = '0';
                    return;
                }
                
                Object.keys(invitationsData).forEach(invitationId => {
                    const invitation = invitationsData[invitationId];
                    invitation.id = invitationId;
                    
                    if (!invitation.status || invitation.status === 'pending') {
                        invitations.push(invitation);
                        const sender = allUsers[invitation.fromUserId] || {};
                        const senderName = sender.name || sender.email || '–ù–µ–≤—ñ–¥–æ–º–∏–π';
                        const chatName = invitation.chatName || '—á–∞—Ç';
                        const invitationElement = document.createElement('div');
                        invitationElement.className = 'invitation-item';
                        invitationElement.innerHTML = `
                            <div style="font-weight: bold; margin-bottom: 5px;">${senderName} –∑–∞–ø—Ä–æ—à—É—î –≤–∞—Å</div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">–î–æ —á–∞—Ç—É: <strong>${chatName}</strong></div>
                            <div style="font-size: 11px; color: #888;">${new Date(invitation.timestamp).toLocaleDateString()}</div>
                            <div class="invitation-actions">
                                <button class="invitation-btn accept-btn" onclick="acceptInvitation('${invitationId}', '${invitation.chatId}')">–ü—Ä–∏–π–Ω—è—Ç–∏</button>
                                <button class="invitation-btn decline-btn" onclick="declineInvitation('${invitationId}')">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
                            </div>
                        `;
                        container.appendChild(invitationElement);
                    }
                });
                
                document.getElementById('invitationsCount').textContent = invitations.length;
                if (invitations.length === 0) {
                    container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">–ù–µ–º–∞—î –Ω–æ–≤–∏—Ö –∑–∞–ø—Ä–æ—à–µ–Ω—å</div>';
                }
            });
        }

        async function createGlobalChat() {
            db.ref('chats/global').once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    db.ref('chats/global').set({
                        name: 'üåç –ó–∞–≥–∞–ª—å–Ω–∏–π —á–∞—Ç',
                        description: '–ü—É–±–ª—ñ—á–Ω–∏–π —á–∞—Ç –¥–ª—è –≤—Å—ñ—Ö',
                        isPublic: true,
                        participants: { [currentUser.uid]: true },
                        createdAt: Date.now()
                    });
                }
            });
        }

        function selectChat(chat) {
            currentChat = chat;
            document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
            const chatItems = document.querySelectorAll('.chat-item');
            for (let item of chatItems) {
                if (item.textContent.includes(chat.name)) {
                    item.classList.add('active');
                    break;
                }
            }
            
            document.getElementById('chatTitle').textContent = chat.name || '–ß–∞—Ç';
            updateMembersCount();
            document.getElementById('chatActions').style.display = chat.id !== 'global' ? 'flex' : 'none';
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('messageInput').focus();
            loadMessages(chat.id);
        }

        function updateMembersCount() {
            if (currentChat && currentChat.participants) {
                const memberCount = Object.keys(currentChat.participants).length;
                document.getElementById('membersCount').textContent = `${memberCount} —É—á–∞—Å–Ω–∏–∫—ñ–≤`;
            } else {
                document.getElementById('membersCount').textContent = '0 —É—á–∞—Å–Ω–∏–∫—ñ–≤';
            }
        }

        function loadMessages(chatId) {
            const container = document.getElementById('messages');
            container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
            
            db.ref('messages/' + chatId).on('value', (snapshot) => {
                const messagesData = snapshot.val();
                displayMessages(messagesData);
            });
        }

        function displayMessages(messagesData) {
            const container = document.getElementById('messages');
            
            if (!messagesData) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 40px 20px;">–©–µ –Ω–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å. –ù–∞–ø–∏—à—ñ—Ç—å –ø–µ—Ä—à–µ! üëã</div>';
                return;
            }
            
            container.innerHTML = '';
            
            const messagesArray = Object.keys(messagesData).map(key => ({
                id: key,
                ...messagesData[key]
            }));
            
            messagesArray.sort((a, b) => a.timestamp - b.timestamp);
            
            let lastDate = null;
            
            messagesArray.forEach(msg => {
                const messageDate = new Date(msg.timestamp).toLocaleDateString();
                if (messageDate !== lastDate) {
                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'system-message';
                    dateDiv.textContent = formatDate(msg.timestamp);
                    container.appendChild(dateDiv);
                    lastDate = messageDate;
                }
                
                const isSystem = msg.senderId === 'system';
                const isMyMessage = msg.senderId === currentUser.uid;
                const senderUser = allUsers[msg.senderId] || {};
                const senderName = isMyMessage ? '–í–∏' : (msg.senderName || senderUser.name || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á');
                
                const messageDiv = document.createElement('div');
                
                if (isSystem) {
                    messageDiv.className = 'system-message';
                    messageDiv.textContent = msg.text;
                } else {
                    messageDiv.className = `message ${isMyMessage ? 'my-message' : 'other-message'}`;
                    
                    const time = new Date(msg.timestamp);
                    const timeString = time.toLocaleTimeString('uk-UA', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    let messageContent = msg.text || '';
                    
                    if (msg.type === 'file' && msg.fileData) {
                        const fileName = msg.fileData.name || '—Ñ–∞–π–ª';
                        const fileSize = msg.fileData.size ? formatFileSize(msg.fileData.size) : '';
                        messageContent = `
                            <div class="file-message">
                                <div class="file-preview">
                                    <div class="file-icon">üìé</div>
                                    <div class="file-info">
                                        <div class="file-name">${fileName}</div>
                                        <div class="file-size">${fileSize}</div>
                                    </div>
                                    <button class="download-btn" onclick="downloadFile('${msg.fileData.data}', '${fileName}')">
                                        ‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (msg.type === 'voice' && msg.audioData) {
                        messageContent = `
                            <div class="voice-message">
                                <div class="voice-player">
                                    <button class="play-btn" onclick="playVoiceMessage('${msg.id}', '${msg.audioData}')">
                                        ‚ñ∂Ô∏è
                                    </button>
                                    <div class="voice-duration">${msg.duration || 0}—Å</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    messageDiv.innerHTML = `
                        <div class="message-sender" onclick="showUserProfile('${msg.senderId}')">
                            ${senderName}
                            ${!isMyMessage ? '<span style="font-size: 10px;">üëÅÔ∏è</span>' : ''}
                        </div>
                        <div>${messageContent}</div>
                        <div style="font-size: 11px; margin-top: 5px; opacity: 0.7; text-align: right;">
                            ${timeString}
                        </div>
                    `;
                }
                
                container.appendChild(messageDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return '–°—å–æ–≥–æ–¥–Ω—ñ';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return '–í—á–æ—Ä–∞';
            } else {
                return date.toLocaleDateString('uk-UA', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentChat || !currentUser) return;
            
            try {
                const messageData = {
                    text: text,
                    senderId: currentUser.uid,
                    senderName: currentUser.email.split('@')[0],
                    timestamp: Date.now()
                };
                
                await db.ref('messages/' + currentChat.id).push(messageData);
                
                await db.ref('chats/' + currentChat.id).update({
                    lastMessage: {
                        text: text,
                        senderId: currentUser.uid,
                        timestamp: Date.now()
                    },
                    lastMessageTime: Date.now()
                });
                
                input.value = '';
                input.style.height = 'auto';
                input.focus();
                
            } catch (error) {
                showNotification('–ü–æ–º–∏–ª–∫–∞: ' + error.message, 'error');
            }
        }

        async function createChat() {
            const chatName = prompt('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –Ω–æ–≤–æ–≥–æ —á–∞—Ç—É:');
            if (!chatName) return;
            
            try {
                const chatId = 'chat_' + Date.now();
                const chatData = {
                    name: chatName,
                    createdBy: currentUser.uid,
                    createdAt: Date.now(),
                    participants: {
                        [currentUser.uid]: true
                    }
                };
                
                await db.ref('chats/' + chatId).set(chatData);
                
                await db.ref('messages/' + chatId).push({
                    text: `–ß–∞—Ç "${chatName}" —Å—Ç–≤–æ—Ä–µ–Ω–æ! –¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ –∑–∞–ø—Ä–æ—Å–∏—Ç–∏ –¥—Ä—É–∑—ñ–≤. üëã`,
                    senderId: 'system',
                    senderName: '–°–∏—Å—Ç–µ–º–∞',
                    timestamp: Date.now()
                });
                
                showNotification('–ß–∞—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ! –¢–µ–ø–µ—Ä –∑–∞–ø—Ä–æ—Å—ñ—Ç—å –¥—Ä—É–∑—ñ–≤.');
                
                selectChat({ id: chatId, ...chatData });
                
            } catch (error) {
                showNotification('–ü–æ–º–∏–ª–∫–∞: ' + error.message, 'error');
            }
        }

        function showInviteModal() {
            if (!currentChat) return;
            showModal('inviteModal');
        }

        async function sendInvitation() {
            const email = document.getElementById('inviteEmail').value.trim();
            
            if (!email) {
                showNotification('–í–≤–µ–¥—ñ—Ç—å email –¥—Ä—É–≥–∞', 'error');
                return;
            }
            
            if (!currentChat) {
                showNotification('–°–ø–µ—Ä—à—É –æ–±–µ—Ä—ñ—Ç—å —á–∞—Ç', 'error');
                return;
            }
            
            try {
                let invitedUserId = null;
                for (const userId in allUsers) {
                    if (allUsers[userId].email === email) {
                        invitedUserId = userId;
                        break;
                    }
                }
                
                if (!invitedUserId) {
                    showNotification('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ —Ç–∞–∫–∏–º email –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
                    return;
                }
                
                if (invitedUserId === currentUser.uid) {
                    showNotification('–í–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∑–∞–ø—Ä–æ—Å–∏—Ç–∏ —Å–∞–º—ñ —Å–µ–±–µ', 'error');
                    return;
                }
                
                if (currentChat.participants && currentChat.participants[invitedUserId]) {
                    showNotification('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ —î –≤ —Ü—å–æ–º—É —á–∞—Ç—ñ', 'error');
                    return;
                }
                
                const invitationData = {
                    fromUserId: currentUser.uid,
                    toUserId: invitedUserId,
                    chatId: currentChat.id,
                    chatName: currentChat.name,
                    status: 'pending',
                    timestamp: Date.now()
                };
                
                await db.ref('invitations').push(invitationData);
                
                showNotification('–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ! ‚úÖ');
                closeModal('inviteModal');
                
            } catch (error) {
                showNotification('–ü–æ–º–∏–ª–∫–∞: ' + error.message, 'error');
            }
        }

        async function acceptInvitation(invitationId, chatId) {
            try {
                await db.ref('invitations/' + invitationId).update({
                    status: 'accepted',
                    respondedAt: Date.now()
                });
                
                await db.ref('chats/' + chatId + '/participants/' + currentUser.uid).set(true);
                
                await db.ref('messages/' + chatId).push({
                    text: `${currentUser.email.split('@')[0]} –ø—Ä–∏—î–¥–Ω–∞–≤—Å—è –¥–æ —á–∞—Ç—É! üéâ`,
                    senderId: 'system',
                    senderName: '–°–∏—Å—Ç–µ–º–∞',
                    timestamp: Date.now()
                });
                
                showNotification('–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç–æ! –í–∏ —Ç–µ–ø–µ—Ä —É —á–∞—Ç—ñ.');
                
                db.ref('chats/' + chatId).once('value').then(snapshot => {
                    const chat = snapshot.val();
                    if (chat) {
                        selectChat({ id: chatId, ...chat });
                    }
                });
                
            } catch (error) {
                showNotification('–ü–æ–º–∏–ª–∫–∞: ' + error.message, 'error');
            }
        }

        async function declineInvitation(invitationId) {
            try {
                await db.ref('invitations/' + invitationId).update({
                    status: 'declined',
                    respondedAt: Date.now()
                });
                
                showNotification('–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ');
                
                // –û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ª–µ email –≤ –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ, —è–∫—â–æ –≤–æ–Ω–æ –≤—ñ–¥–∫—Ä–∏—Ç–µ
                const inviteEmail = document.getElementById('inviteEmail');
                if (inviteEmail) {
                    inviteEmail.value = '';
                }
                
            } catch (error) {
                showNotification('–ü–æ–º–∏–ª–∫–∞: ' + error.message, 'error');
            }
        }

        // ========== –§–£–ù–ö–¶–Ü–û–ù–ê–õ –ü–ï–†–ï–ì–õ–Ø–î–£ –ü–†–û–§–Ü–õ–Ü–í ==========
        async function showMyProfile() {
            if (!currentUser) return;
            await loadUserProfile(currentUser.uid, true);
        }

        async function showUserProfile(userId) {
            if (!userId || userId === 'system') return;
            // –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ: –ø–µ—Ä–µ–¥–∞—î–º–æ chatId —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ currentChat —ñ—Å–Ω—É—î
            const chatId = currentChat ? currentChat.id : null;
            await loadUserProfile(userId, userId === currentUser.uid, chatId);
        }

        async function loadUserProfile(userId, isMyProfile = false, chatId = null) {
            try {
                const userSnapshot = await db.ref('users/' + userId).once('value');
                const user = userSnapshot.val();
                
                if (!user) {
                    showNotification('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
                    return;
                }
                
                // –§–Ü–ö–°: –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å uid
                const userUid = user.uid || userId || '';
                const uidDisplay = userUid && userUid.substring ? userUid.substring(0, 8) + '...' : '–ù/–î';
                
                let chat = null;
                let isCreator = false;
                
                // –û—Ç—Ä–∏–º—É—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —á–∞—Ç —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ chatId –ø–µ—Ä–µ–¥–∞–Ω–æ
                if (chatId) {
                    const chatSnapshot = await db.ref('chats/' + chatId).once('value');
                    chat = chatSnapshot.val();
                    isCreator = chat && chat.createdBy === userId;
                }
                
                const isOnline = user.online === true;
                const firstLetter = user.name ? user.name.charAt(0).toUpperCase() : 'U';
                const userName = user.name || user.email?.split('@')[0] || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á';
                const userEmail = user.email || '–ù–µ–º–∞—î email';
                const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString('uk-UA') : '–ù/–î';
                const lastSeen = user.lastSeen ? 
                    `${new Date(user.lastSeen).toLocaleDateString('uk-UA')} ${new Date(user.lastSeen).toLocaleTimeString('uk-UA')}` : 
                    '–ù/–î';
                
                let profileHTML = '';
                
                if (isMyProfile) {
                    profileHTML = `
                        <div class="profile-header">
                            <div class="profile-avatar">${firstLetter}</div>
                            <div class="profile-name">${userName}</div>
                            <div class="profile-email">${userEmail}</div>
                            <div class="profile-badges">
                                <span class="profile-badge profile-you">–í–∏</span>
                                ${isCreator ? '<span class="profile-badge profile-creator">–°—Ç–≤–æ—Ä–∏–≤</span>' : ''}
                                <span class="profile-badge ${isOnline ? 'profile-online' : 'profile-offline'}">
                                    ${isOnline ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ–ª–∞–π–Ω'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="profile-details">
                            <div class="profile-row">
                                <span class="profile-label">ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:</span>
                                <span class="profile-value">${uidDisplay}</span>
                            </div>
                            <div class="profile-row">
                                <span class="profile-label">–ó–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ:</span>
                                <span class="profile-value">${createdAt}</span>
                            </div>
                            <div class="profile-row">
                                <span class="profile-label">–û—Å—Ç–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å:</span>
                                <span class="profile-value">${lastSeen}</span>
                            </div>
                            <div class="profile-row">
                                <span class="profile-label">Email:</span>
                                <span class="profile-value">${userEmail}</span>
                            </div>
                            ${chat ? `
                                <div class="profile-row">
                                    <span class="profile-label">–†–æ–ª—å –≤ —á–∞—Ç—ñ:</span>
                                    <span class="profile-value">${isCreator ? '–°—Ç–≤–æ—Ä–∏–≤ —á–∞—Ç' : '–£—á–∞—Å–Ω–∏–∫'}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="profile-actions">
                            <button class="profile-btn secondary" onclick="closeModal('profileModal')">
                                –ó–∞–∫—Ä–∏—Ç–∏
                            </button>
                        </div>
                    `;
                } else {
                    profileHTML = `
                        <div class="profile-header">
                            <div class="profile-avatar">${firstLetter}</div>
                            <div class="profile-name">${userName}</div>
                            <div class="profile-email">${userEmail}</div>
                            <div class="profile-badges">
                                ${isCreator ? '<span class="profile-badge profile-creator">–°—Ç–≤–æ—Ä–∏–≤ —á–∞—Ç</span>' : ''}
                                <span class="profile-badge ${isOnline ? 'profile-online' : 'profile-offline'}">
                                    ${isOnline ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ–ª–∞–π–Ω'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="profile-details">
                            <div class="profile-row">
                                <span class="profile-label">–Ü–º'—è:</span>
                                <span class="profile-value">${userName}</span>
                            </div>
                            <div class="profile-row">
                                <span class="profile-label">Email:</span>
                                <span class="profile-value">${userEmail}</span>
                            </div>
                            <div class="profile-row">
                                <span class="profile-label">–°—Ç–∞—Ç—É—Å:</span>
                                <span class="profile-value">${isOnline ? 'üü¢ –û–Ω–ª–∞–π–Ω' : '‚ö´ –û—Ñ–ª–∞–π–Ω'}</span>
                            </div>
                            <div class="profile-row">
                                <span class="profile-label">–í —Å–∏—Å—Ç–µ–º—ñ –∑:</span>
                                <span class="profile-value">${createdAt}</span>
                            </div>
                            ${chat ? `
                                <div class="profile-row">
                                    <span class="profile-label">–†–æ–ª—å –≤ —á–∞—Ç—ñ:</span>
                                    <span class="profile-value">${isCreator ? 'üëë –°—Ç–≤–æ—Ä–∏–≤ —á–∞—Ç' : 'üë§ –£—á–∞—Å–Ω–∏–∫'}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="profile-actions">
                            ${chat && chat.participants && chat.participants[userId] && userId !== currentUser.uid ? `
                                <button class="profile-btn primary" onclick="showChatWithUser('${userId}', '${userName}')">
                                    üí¨ –ù–∞–ø–∏—Å–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                                </button>
                            ` : ''}
                            <button class="profile-btn secondary" onclick="closeModal('profileModal')">
                                –ó–∞–∫—Ä–∏—Ç–∏
                            </button>
                        </div>
                    `;
                }
                
                document.getElementById('profileContent').innerHTML = profileHTML;
                showModal('profileModal');
                
            } catch (error) {
                showNotification('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é: ' + error.message, 'error');
            }
        }

        function showChatWithUser(userId, userName) {
            showNotification(`–§—É–Ω–∫—Ü—ñ—è –ø—Ä–∏–≤–∞—Ç–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∑ ${userName} –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ üöß`);
            closeModal('profileModal');
        }

        // ========== –§–£–ù–ö–¶–Ü–û–ù–ê–õ –ü–ï–†–ï–ì–õ–Ø–î–£ –£–ß–ê–°–ù–ò–ö–Ü–í ==========
        async function showMembersModal() {
            if (!currentChat) {
                showNotification('–°–ø–µ—Ä—à—É –æ–±–µ—Ä—ñ—Ç—å —á–∞—Ç!', 'error');
                return;
            }
            
            showModal('membersModal');
            loadChatMembers();
        }

        async function loadChatMembers() {
            if (!currentChat) return;
            
            const membersList = document.getElementById('membersList');
            const membersTitle = document.getElementById('membersTitle');
            
            membersList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
            membersTitle.textContent = `–£—á–∞—Å–Ω–∏–∫–∏ —á–∞—Ç—É "${currentChat.name}"`;
            
            try {
                const chatSnapshot = await db.ref('chats/' + currentChat.id).once('value');
                const chat = chatSnapshot.val();
                
                if (!chat || !chat.participants) {
                    membersList.innerHTML = '<div class="no-members">–ù–µ–º–∞—î —É—á–∞—Å–Ω–∏–∫—ñ–≤</div>';
                    return;
                }
                
                const participants = chat.participants;
                const participantIds = Object.keys(participants);
                
                if (participantIds.length === 0) {
                    membersList.innerHTML = '<div class="no-members">–ù–µ–º–∞—î —É—á–∞—Å–Ω–∏–∫—ñ–≤</div>';
                    return;
                }
                
                membersList.innerHTML = '';
                
                for (const userId of participantIds) {
                    const userSnapshot = await db.ref('users/' + userId).once('value');
                    const user = userSnapshot.val();
                    
                    if (user) {
                        const memberItem = document.createElement('div');
                        memberItem.className = 'member-item';
                        memberItem.onclick = () => showUserProfile(userId);
                        
                        const isCreator = userId === chat.createdBy;
                        const isCurrentUser = userId === currentUser.uid;
                        const isOnline = user.online === true;
                        const userName = user.name || user.email?.split('@')[0] || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á';
                        const firstLetter = userName ? userName.charAt(0).toUpperCase() : 'U';
                        
                        memberItem.innerHTML = `
                            <div class="member-info">
                                <div class="member-avatar">${firstLetter}</div>
                                <div class="member-details">
                                    <div class="member-name">
                                        ${userName}
                                        ${isCreator ? '<span class="creator-badge">–°—Ç–≤–æ—Ä–∏–≤</span>' : ''}
                                        ${isCurrentUser ? '<span class="you-badge">–í–∏</span>' : ''}
                                    </div>
                                    <div class="member-email">${user.email || ''}</div>
                                </div>
                                <div class="member-status ${isOnline ? '' : 'offline'}">
                                    ${isOnline ? 'üü¢' : '‚ö´'}
                                </div>
                            </div>
                        `;
                        
                        membersList.appendChild(memberItem);
                    }
                }
                
            } catch (error) {
                showNotification('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —É—á–∞—Å–Ω–∏–∫—ñ–≤: ' + error.message, 'error');
                membersList.innerHTML = '<div class="no-members">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div>';
            }
        }

        // ========== –†–û–ë–û–¢–ê –ó –§–ê–ô–õ–ê–ú–ò ==========
        function attachFile() {
            if (!currentChat) {
                showNotification('–°–ø–µ—Ä—à—É –æ–±–µ—Ä—ñ—Ç—å —á–∞—Ç!', 'error');
                return;
            }
            
            showModal('fileModal');
            
            document.getElementById('fileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const preview = document.getElementById('filePreview');
                
                if (!file) {
                    preview.style.display = 'none';
                    return;
                }
                
                if (file.size > 10 * 1024 * 1024) {
                    showNotification('–§–∞–π–ª –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π (–º–∞–∫—Å. 10MB)', 'error');
                    e.target.value = '';
                    preview.style.display = 'none';
                    return;
                }
                
                let previewHTML = '';
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewHTML = `
                            <div style="text-align: center;">
                                <img src="${e.target.result}" style="max-width: 200px; max-height: 150px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-size: 14px; color: #333;">
                                    ${file.name} (${formatFileSize(file.size)})
                                </div>
                            </div>
                        `;
                        preview.innerHTML = previewHTML;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    const icon = getFileIcon(file);
                    previewHTML = `
                        <div style="display: flex; align-items: center; gap: 15px; padding: 10px; background: #f8f9ff; border-radius: 8px;">
                            <div style="font-size: 36px;">${icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 14px;">${file.name}</div>
                                <div style="font-size: 12px; color: #666;">
                                    ${file.type} ‚Ä¢ ${formatFileSize(file.size)}
                                </div>
                            </div>
                        </div>
                    `;
                    preview.innerHTML = previewHTML;
                    preview.style.display = 'block';
                }
            });
        }

        function getFileIcon(file) {
            const type = file.type;
            if (type.startsWith('image/')) return 'üñºÔ∏è';
            if (type.startsWith('video/')) return 'üé¨';
            if (type.startsWith('audio/')) return 'üéµ';
            if (type.includes('pdf')) return 'üìÑ';
            if (type.includes('word')) return 'üìù';
            if (type.includes('excel')) return 'üìä';
            if (type.includes('zip') || type.includes('rar')) return 'üóúÔ∏è';
            return 'üìé';
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('–í–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª!', 'error');
                return;
            }
            
            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const fileData = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result,
                        uploadedBy: currentUser.uid,
                        timestamp: Date.now()
                    };
                    
                    await db.ref('messages/' + currentChat.id).push({
                        type: 'file',
                        fileData: fileData,
                        senderId: currentUser.uid,
                        senderName: currentUser.email.split('@')[0],
                        timestamp: Date.now()
                    });
                    
                    showNotification(`–§–∞–π–ª "${file.name}" –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ! üìé`);
                    closeModal('fileModal');
                    
                    await db.ref('chats/' + currentChat.id).update({
                        lastMessage: {
                            text: `üìé ${file.name}`,
                            senderId: currentUser.uid,
                            timestamp: Date.now()
                        },
                        lastMessageTime: Date.now()
                    });
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                showNotification('–ü–æ–º–∏–ª–∫–∞: ' + error.message, 'error');
            }
        }

        function downloadFile(dataUrl, fileName) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('–§–∞–π–ª –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è...');
        }

        // ========== –ì–û–õ–û–°–û–í–Ü –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø ==========
        async function toggleVoiceRecording() {
            if (!currentChat) {
                showNotification('–°–ø–µ—Ä—à—É –æ–±–µ—Ä—ñ—Ç—å —á–∞—Ç!', 'error');
                return;
            }
            
            if (isRecording) {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        }

        async function startVoiceRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showNotification('–ú—ñ–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è', 'error');
                return;
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await sendVoiceMessage(audioBlob);
                    
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                document.getElementById('recordingIndicator').style.display = 'flex';
                document.getElementById('voiceBtn').innerHTML = '‚èπÔ∏è';
                document.getElementById('voiceRecordBtn').innerHTML = '‚èπÔ∏è –ó—É–ø–∏–Ω–∏—Ç–∏';
                
                setTimeout(() => {
                    if (isRecording) {
                        stopVoiceRecording();
                    }
                }, 60000);
                
            } catch (error) {
                showNotification('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞: ' + error.message, 'error');
            }
        }

        function stopVoiceRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                isRecording = false;
                
                document.getElementById('recordingIndicator').style.display = 'none';
                document.getElementById('voiceBtn').innerHTML = 'üé§';
                document.getElementById('voiceRecordBtn').innerHTML = 'üé§ –ì–æ–ª–æ—Å';
            }
        }

        async function sendVoiceMessage(audioBlob) {
            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const audioData = {
                        data: e.target.result,
                        duration: Math.floor(audioBlob.size / 1000),
                        timestamp: Date.now()
                    };
                    
                    await db.ref('messages/' + currentChat.id).push({
                        type: 'voice',
                        audioData: audioData,
                        senderId: currentUser.uid,
                        senderName: currentUser.email.split('@')[0],
                        timestamp: Date.now()
                    });
                    
                    showNotification('–ì–æ–ª–æ—Å–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ! üé§');
                    
                    await db.ref('chats/' + currentChat.id).update({
                        lastMessage: {
                            text: 'üé§ –ì–æ–ª–æ—Å–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è',
                            senderId: currentUser.uid,
                            timestamp: Date.now()
                        },
                        lastMessageTime: Date.now()
                    });
                };
                
                reader.readAsDataURL(audioBlob);
                
            } catch (error) {
                showNotification('–ü–æ–º–∏–ª–∫–∞: ' + error.message, 'error');
            }
        }

        function playVoiceMessage(messageId, audioData) {
            if (currentPlayingAudio) {
                currentPlayingAudio.pause();
            }
            
            const audio = new Audio(audioData);
            audio.play();
            currentPlayingAudio = audio;
            
            audio.onended = () => {
                currentPlayingAudio = null;
            };
        }

        // ========== –ï–ú–û–î–ó–Ü –ü–Ü–ö–ï–† ==========
        function showEmojiPicker() {
            const input = document.getElementById('messageInput');
            const cursorPos = input.selectionStart;
            const emoji = prompt('–í–≤–µ–¥—ñ—Ç—å –µ–º–æ–¥–∑—ñ –∞–±–æ –æ–±–µ—Ä—ñ—Ç—å –∑—ñ —Å–ø–∏—Å–∫—É: üòÄ üòÇ üòä ‚ù§Ô∏è üëç');
            
            if (emoji) {
                const text = input.value;
                input.value = text.substring(0, cursorPos) + emoji + text.substring(cursorPos);
                input.focus();
                input.selectionStart = input.selectionEnd = cursorPos + emoji.length;
            }
        }

        function showEmojiPickerModal() {
            const picker = document.getElementById('emojiPicker');
            picker.innerHTML = '';
            
            emojis.forEach(emoji => {
                const button = document.createElement('button');
                button.className = 'emoji-btn';
                button.textContent = emoji;
                button.onclick = () => {
                    const input = document.getElementById('messageInput');
                    const cursorPos = input.selectionStart;
                    const text = input.value;
                    input.value = text.substring(0, cursorPos) + emoji + text.substring(cursorPos);
                    input.focus();
                    input.selectionStart = input.selectionEnd = cursorPos + emoji.length;
                    closeModal('emojiModal');
                };
                picker.appendChild(button);
            });
            
            showModal('emojiModal');
        }

        function logout() {
            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø–µ—Ä–µ–¥ –≤–∏—Ö–æ–¥–æ–º
            if (currentUser) {
                db.ref('users/' + currentUser.uid).update({
                    online: false,
                    lastSeen: Date.now()
                });
            }
            auth.signOut();
            location.reload();
        }

        // ========== –î–û–î–ê–¢–ö–û–í–Ü –§–£–ù–ö–¶–Ü–á ==========
        document.getElementById('messageInput')?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
            
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ –≤—ñ–∫–Ω–∞
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                db.ref('users/' + currentUser.uid).update({
                    online: false,
                    lastSeen: Date.now()
                });
            }
        });

        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userEmail').textContent = currentUser.email;
                startChat();
            } else {
                // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∏–π—à–æ–≤
                if (currentUser) {
                    db.ref('users/' + currentUser.uid).update({
                        online: false,
                        lastSeen: Date.now()
                    });
                }
            }
        });

        window.onload = function() {
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –¥–ª—è —Ç–µ—Å—Ç—É
            setTimeout(() => {
                if (!currentUser) {
                    // –†–æ–∑–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è
                    // document.getElementById('email').value = 'user1@chat.com';
                    // document.getElementById('password').value = '123456';
                }
            }, 1000);
        };
    </script>
</body>

</html>



