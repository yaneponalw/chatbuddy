<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí¨ –ß–∞—Ç –∑ –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è–º–∏</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
        body { background: linear-gradient(135deg, #6a11cb, #2575fc); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 1000px; height: 750px; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .auth-screen { padding: 50px; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; }
        .auth-form { width: 100%; max-width: 350px; }
        .auth-input { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 15px; }
        .auth-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #6a11cb, #2575fc); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .error { color: #ff3b30; text-align: center; margin-top: 10px; font-size: 14px; min-height: 20px; }
        .chat-screen { display: none; flex-direction: column; height: 100%; }
        .header { background: linear-gradient(135deg, #6a11cb, #2575fc); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .main { display: flex; flex: 1; height: calc(100% - 60px); }
        .sidebar { width: 300px; background: #f8f9ff; border-right: 1px solid #eaeaea; display: flex; flex-direction: column; }
        .chat-area { flex: 1; display: flex; flex-direction: column; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; background: #fafbff; }
        .input-area { padding: 15px 20px; border-top: 1px solid #eaeaea; display: flex; gap: 10px; background: white; align-items: center; }
        #messageInput { flex: 1; padding: 12px 15px; border: 2px solid #ddd; border-radius: 20px; font-size: 14px; outline: none; min-height: 40px; resize: none; }
        #sendBtn { background: #6a11cb; color: white; border: none; padding: 0 25px; height: 40px; border-radius: 20px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ï–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó -->
        <div class="auth-screen" id="authScreen">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="color: #333; margin-bottom: 10px;">üí¨ –ß–∞—Ç –∑ –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è–º–∏</h1>
                <div style="color: #666;">–ó–∞–ø—Ä–æ—à—É–π –¥—Ä—É–∑—ñ–≤ —Ç–∞ —Å–ø—ñ–ª–∫—É–π—Å—è!</div>
            </div>
            
            <div class="auth-form">
                <input type="email" id="email" class="auth-input" placeholder="Email">
                <input type="password" id="password" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
                <button class="auth-btn" onclick="login()">–£–≤—ñ–π—Ç–∏ / –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
                <div class="error" id="errorMessage"></div>
                
                <div style="text-align: center; margin-top: 30px; color: #666; font-size: 13px;">
                    –í–≤–µ–¥—ñ—Ç—å —Å–≤—ñ–π email —Ç–∞ –ø–∞—Ä–æ–ª—å<br>
                    –Ø–∫—â–æ –∞–∫–∞—É–Ω—Ç–∞ –Ω–µ–º–∞—î ‚Äî –≤—ñ–Ω —Å—Ç–≤–æ—Ä–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
                </div>
            </div>
        </div>
        
        <!-- –ï–∫—Ä–∞–Ω —á–∞—Ç—É -->
        <div class="chat-screen" id="chatScreen">
            <div class="header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button onclick="showMyProfile()" style="background: #6a11cb; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 18px;">üë§</button>
                    <h2>üí¨ –ß–∞—Ç –∑ –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è–º–∏</h2>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span id="userEmail">user@test.com</span>
                    <button onclick="logout()" style="background: #ff3b30; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 13px;">–í–∏–π—Ç–∏</button>
                </div>
            </div>
            
            <div class="main">
                <div class="sidebar">
                    <div style="padding: 20px;">
                        <button onclick="createChat()" style="width: 100%; padding: 12px; background: #6a11cb; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">üí¨ –°—Ç–≤–æ—Ä–∏—Ç–∏ —á–∞—Ç</button>
                    </div>
                    <div style="padding: 20px; border-top: 1px solid #eaeaea;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 15px;">–ú–æ—ó —á–∞—Ç–∏ <span id="chatsCount">0</span></div>
                        <div id="chatsList" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    <div style="padding: 20px; border-top: 1px solid #eaeaea; flex: 1;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 15px;">–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è <span id="invitationsCount">0</span></div>
                        <div id="invitationsList" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
                
                <div class="chat-area">
                    <div style="padding: 15px 20px; background: white; border-bottom: 1px solid #eaeaea;">
                        <div style="font-weight: bold; font-size: 18px; color: #333;" id="chatTitle">–û–±–µ—Ä—ñ—Ç—å —á–∞—Ç</div>
                        <div style="font-size: 13px; color: #666;" id="chatMembers">0 —É—á–∞—Å–Ω–∏–∫—ñ–≤</div>
                    </div>
                    
                    <div class="messages" id="messages">
                        <div style="text-align: center; color: #666; padding: 50px 20px;">
                            <div style="font-size: 60px; margin-bottom: 20px; opacity: 0.5;">üëã</div>
                            <h3 style="margin-bottom: 10px;">–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ!</h3>
                            <p>–û–±–µ—Ä—ñ—Ç—å —á–∞—Ç –∞–±–æ —Å—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π</p>
                        </div>
                    </div>
                    
                    <div class="input-area">
                        <textarea id="messageInput" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." disabled></textarea>
                        <button id="sendBtn" onclick="sendMessage()" disabled>–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ ‚úàÔ∏è</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
        const firebaseConfig = {
            apiKey: "AIzaSyALbB3mUwRXJZW3F6-1DuSL3sZEauTG0j8",
            authDomain: "realchat-b80d7.firebaseapp.com",
            databaseURL: "https://realchat-b80d7-default-rtdb.firebaseio.com",
            projectId: "realchat-b80d7",
            storageBucket: "realchat-b80d7.firebasestorage.app",
            messagingSenderId: "201539346020",
            appId: "1:201539346020:web:de939b088c9db66b0a8971"
        };

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        let currentUser = null;
        let currentChat = null;
        let allUsers = {};

        // –§—É–Ω–∫—Ü—ñ—ó
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            setTimeout(() => errorDiv.textContent = '', 3000);
        }

        function showNotification(message) {
            console.log('Notification:', message);
        }

        async function login() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!email) { 
                showError('–í–≤–µ–¥—ñ—Ç—å email'); 
                return; 
            }
            
            if (!password) { 
                showError('–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å'); 
                return; 
            }
            
            if (password.length < 6) { 
                showError('–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤'); 
                return; 
            }
            
            try {
                let userCredential;
                
                try {
                    userCredential = await auth.signInWithEmailAndPassword(email, password);
                    showNotification('–í—Ö—ñ–¥ —É—Å–ø—ñ—à–Ω–∏–π! üëã');
                } 
                catch (signInError) {
                    if (signInError.code === 'auth/user-not-found' || signInError.code === 'auth/wrong-password') {
                        userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        showNotification('–ù–æ–≤–∏–π –∞–∫–∞—É–Ω—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ! üéâ');
                    } else {
                        throw signInError;
                    }
                }
                
                currentUser = userCredential.user;
                
                await db.ref('users/' + currentUser.uid).update({
                    uid: currentUser.uid,
                    email: email,
                    name: email.split('@')[0],
                    online: true,
                    lastSeen: Date.now(),
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                document.getElementById('userEmail').textContent = currentUser.email;
                startChat();
                
            } catch (error) {
                let errorMessage = '';
                
                switch(error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = '–¶–µ–π email –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π. –°–ø—Ä–æ–±—É–π—Ç–µ —É–≤—ñ–π—Ç–∏.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = '–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç email';
                        break;
                    case 'auth/weak-password':
                        errorMessage = '–ü–∞—Ä–æ–ª—å –∑–∞–Ω–∞–¥—Ç–æ —Å–ª–∞–±–∫–∏–π. –ú—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = '–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.';
                        break;
                    case 'auth/user-not-found':
                        errorMessage = '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –∞–∫–∞—É–Ω—Ç.';
                        break;
                    default:
                        errorMessage = '–ü–æ–º–∏–ª–∫–∞: ' + error.message;
                }
                
                showError(errorMessage);
            }
        }

        function startChat() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'flex';
            loadAllUsers();
            loadMyChats();
            loadInvitations();
            createGlobalChat();
        }

        function loadAllUsers() {
            db.ref('users').on('value', (snapshot) => {
                allUsers = snapshot.val() || {};
                
                if (currentUser) {
                    db.ref('users/' + currentUser.uid).update({
                        online: true,
                        lastSeen: Date.now()
                    });
                }
            });
        }

        function loadMyChats() {
            db.ref('chats').on('value', (snapshot) => {
                const chatsData = snapshot.val();
                const container = document.getElementById('chatsList');
                let myChats = [];
                container.innerHTML = '';
                
                if (!chatsData) {
                    container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">–©–µ –Ω–µ–º–∞—î —á–∞—Ç—ñ–≤</div>';
                    document.getElementById('chatsCount').textContent = '0';
                    return;
                }
                
                Object.keys(chatsData).forEach(chatId => {
                    const chat = chatsData[chatId];
                    chat.id = chatId;
                    
                    if (chat.participants && chat.participants[currentUser.uid]) {
                        myChats.push(chat);
                        const memberCount = chat.participants ? Object.keys(chat.participants).length : 0;
                        const chatElement = document.createElement('div');
                        chatElement.style.cssText = 'padding: 12px; background: white; border-radius: 10px; margin-bottom: 10px; border: 2px solid #ddd; cursor: pointer;';
                        chatElement.onclick = () => selectChat(chat);
                        chatElement.innerHTML = `
                            <div style="font-weight: bold; margin-bottom: 3px;">${chat.name || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</div>
                            <div style="font-size: 12px; color: #666;">${memberCount} —É—á–∞—Å–Ω–∏–∫—ñ–≤</div>
                        `;
                        container.appendChild(chatElement);
                    }
                });
                
                document.getElementById('chatsCount').textContent = myChats.length;
                if (myChats.length === 0) {
                    container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">–£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î —á–∞—Ç—ñ–≤</div>';
                }
            });
        }

        function loadInvitations() {
            db.ref('invitations').orderByChild('toUserId').equalTo(currentUser.uid).on('value', (snapshot) => {
                const invitationsData = snapshot.val();
                const container = document.getElementById('invitationsList');
                let invitations = [];
                container.innerHTML = '';
                
                if (!invitationsData) {
                    container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">–ù–µ–º–∞—î –∑–∞–ø—Ä–æ—à–µ–Ω—å</div>';
                    document.getElementById('invitationsCount').textContent = '0';
                    return;
                }
                
                Object.keys(invitationsData).forEach(invitationId => {
                    const invitation = invitationsData[invitationId];
                    invitation.id = invitationId;
                    
                    if (!invitation.status || invitation.status === 'pending') {
                        invitations.push(invitation);
                        const sender = allUsers[invitation.fromUserId] || {};
                        const senderName = sender.name || sender.email || '–ù–µ–≤—ñ–¥–æ–º–∏–π';
                        const invitationElement = document.createElement('div');
                        invitationElement.style.cssText = 'padding: 12px; background: white; border-radius: 10px; margin-bottom: 10px; border: 2px solid #ddd;';
                        invitationElement.innerHTML = `
                            <div style="font-weight: bold; margin-bottom: 5px;">${senderName} –∑–∞–ø—Ä–æ—à—É—î –≤–∞—Å</div>
                            <div style="font-size: 13px; color: #666;">–î–æ —á–∞—Ç—É: <strong>${invitation.chatName || '—á–∞—Ç'}</strong></div>
                            <div style="margin-top: 10px; display: flex; gap: 5px;">
                                <button onclick="acceptInvitation('${invitationId}', '${invitation.chatId}')" style="flex: 1; padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">–ü—Ä–∏–π–Ω—è—Ç–∏</button>
                                <button onclick="declineInvitation('${invitationId}')" style="flex: 1; padding: 8px; background: #ff3b30; color: white; border: none; border-radius: 5px; cursor: pointer;">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
                            </div>
                        `;
                        container.appendChild(invitationElement);
                    }
                });
                
                document.getElementById('invitationsCount').textContent = invitations.length;
                if (invitations.length === 0) {
                    container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">–ù–µ–º–∞—î –Ω–æ–≤–∏—Ö –∑–∞–ø—Ä–æ—à–µ–Ω—å</div>';
                }
            });
        }

        function createGlobalChat() {
            db.ref('chats/global').once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    db.ref('chats/global').set({
                        name: 'üåç –ó–∞–≥–∞–ª—å–Ω–∏–π —á–∞—Ç',
                        participants: { [currentUser.uid]: true },
                        createdAt: Date.now()
                    });
                }
            });
        }

        function selectChat(chat) {
            currentChat = chat;
            document.getElementById('chatTitle').textContent = chat.name || '–ß–∞—Ç';
            document.getElementById('chatMembers').textContent = `${Object.keys(chat.participants || {}).length} —É—á–∞—Å–Ω–∏–∫—ñ–≤`;
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            loadMessages(chat.id);
        }

        function loadMessages(chatId) {
            const container = document.getElementById('messages');
            container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
            
            db.ref('messages/' + chatId).on('value', (snapshot) => {
                const messagesData = snapshot.val();
                container.innerHTML = '';
                
                if (!messagesData) {
                    container.innerHTML = '<div style="text-align: center; color: #666; padding: 40px 20px;">–©–µ –Ω–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</div>';
                    return;
                }
                
                Object.keys(messagesData).forEach(key => {
                    const msg = messagesData[key];
                    const isMyMessage = msg.senderId === currentUser.uid;
                    const messageDiv = document.createElement('div');
                    messageDiv.style.cssText = `max-width: 70%; margin: 8px 0; padding: 12px 15px; border-radius: 15px; background: ${isMyMessage ? 'linear-gradient(135deg, #6a11cb, #2575fc)' : 'white'}; color: ${isMyMessage ? 'white' : '#333'}; ${isMyMessage ? 'margin-left: auto;' : 'margin-right: auto;'}`;
                    messageDiv.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 5px;">${isMyMessage ? '–í–∏' : (msg.senderName || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á')}</div>
                        <div>${msg.text || ''}</div>
                        <div style="font-size: 11px; margin-top: 5px; text-align: right;">${new Date(msg.timestamp).toLocaleTimeString('uk-UA', {hour: '2-digit', minute: '2-digit'})}</div>
                    `;
                    container.appendChild(messageDiv);
                });
                
                container.scrollTop = container.scrollHeight;
            });
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentChat || !currentUser) return;
            
            try {
                await db.ref('messages/' + currentChat.id).push({
                    text: text,
                    senderId: currentUser.uid,
                    senderName: currentUser.email.split('@')[0],
                    timestamp: Date.now()
                });
                
                input.value = '';
            } catch (error) {
                showError('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }

        async function createChat() {
            const chatName = prompt('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –Ω–æ–≤–æ–≥–æ —á–∞—Ç—É:');
            if (!chatName) return;
            
            try {
                const chatId = 'chat_' + Date.now();
                await db.ref('chats/' + chatId).set({
                    name: chatName,
                    createdBy: currentUser.uid,
                    participants: { [currentUser.uid]: true },
                    createdAt: Date.now()
                });
                
                showNotification('–ß–∞—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ!');
                selectChat({ id: chatId, name: chatName, participants: { [currentUser.uid]: true } });
                
            } catch (error) {
                showError('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }

        async function acceptInvitation(invitationId, chatId) {
            try {
                await db.ref('invitations/' + invitationId).update({ status: 'accepted' });
                await db.ref('chats/' + chatId + '/participants/' + currentUser.uid).set(true);
                showNotification('–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç–æ!');
            } catch (error) {
                showError('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }

        async function declineInvitation(invitationId) {
            try {
                await db.ref('invitations/' + invitationId).update({ status: 'declined' });
                showNotification('–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ');
            } catch (error) {
                showError('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }

        function showMyProfile() {
            alert(`–í–∞—à –ø—Ä–æ—Ñ—ñ–ª—å:\nEmail: ${currentUser.email}\nID: ${currentUser.uid.substring(0, 8)}...`);
        }

        function logout() {
            if (currentUser) {
                db.ref('users/' + currentUser.uid).update({
                    online: false,
                    lastSeen: Date.now()
                });
            }
            auth.signOut();
            location.reload();
        }

        // –û–±—Ä–æ–±–∫–∞ Enter –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        document.getElementById('messageInput')?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userEmail').textContent = currentUser.email;
                startChat();
            }
        });
    </script>
</body>
</html>
